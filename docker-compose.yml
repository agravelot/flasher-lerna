version: '3.4'
services:
  db:
    image: mariadb
    restart: always
    volumes:
    - db-data:/var/lib/mysql
    env_file:
    - docker/db/.env

  php:
    image: registry.gitlab.com/nevax/picblog/picblog_php
    build:
      context: .
      dockerfile: Dockerfile
      target: php
    restart: always
    env_file:
    - docker/php-fpm/.env
    volumes:
    - storage:/var/www/html/storage
    - public_vendor:/var/www/html/public/vendor
    links:
    - db
    - cache
    depends_on:
    - db
    - cache

  nginx:
    image: registry.gitlab.com/nevax/picblog/picblog_nginx
    build:
      context: .
      dockerfile: Dockerfile
      target: nginx
    restart: always
    ports:
    - 80:80
    - 443:443
    env_file: ./docker/nginx/.env
    volumes:
    - storage:/var/www/html/storage:ro
    - public_vendor:/var/www/html/public/vendor:ro
#    - certs:/etc/nginx/certs:ro
    depends_on:
    - php
    - letsencrypt
    links:
    - php
    - letsencrypt

  letsencrypt:
    build:
      context: .
      dockerfile: Dockerfile
      target: letsencrypt
    volumes:
      - certs:/etc/letsencrypt:rw
    ports:
      - 80
      - 443
    command: certonly -d example.com --text --agree-tos --email some@email.com --rsa-key-size 4096 --renew-by-default --preferred-challenges http-01 --non-interactive

  cache:
    image: redis:5.0-alpine

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    restart: unless-stopped
    links:
    - db
    depends_on:
    - db
    ports:
    - 8082:80
    environment:
    - PHP_UPLOAD_MAX_FILESIZE=100MB

volumes:
  db-data:
  storage:
  public_vendor:
  certs:

version: '3.7'
services:

  php: &php_base
    image: registry.gitlab.com/flasher/flasher/picblog_php:${CI_COMMIT_SHORT_SHA:-latest}
    build:
      context: .
      dockerfile: Dockerfile
      target: php_app
    restart: unless-stopped
    networks:
      - database-network
    env_file:
      - docker/php-fpm/.env
    volumes:
      - storage:/var/www/html/storage:rw,delegated
      - public_vendor:/var/www/html/public/vendor:rw,delegated

  queue:
    <<: *php_base
    build:
      context: .
      dockerfile: Dockerfile
      target: php_queue
    environment:
      CONTAINER_ROLE: "queue"

  scheduler:
    <<: *php_base
    build:
      context: .
      dockerfile: Dockerfile
      target: php_scheduler
    user: root
    environment:
      CONTAINER_ROLE: "scheduler"

  publisher:
    <<: *php_base
    build:
      context: .
      dockerfile: Dockerfile
      target: php_publisher
    restart: on-failure
    environment:
      CONTAINER_ROLE: "publisher"

  nginx:
    image: registry.gitlab.com/flasher/flasher/picblog_nginx:${CI_COMMIT_SHORT_SHA:-latest}
    build:
      context: .
      dockerfile: Dockerfile
      target: nginx
    restart: unless-stopped
    expose:
      - 80
    networks:
      - nginx-proxy
    env_file: ./docker/nginx/.env
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.flasher-${APP_ENV}.rule=Host(`${APP_URL}`) || Host(`www.${APP_URL}`)"
      - "traefik.http.routers.flasher-${APP_ENV}.entrypoints=websecure"
      - "traefik.http.routers.flasher-${APP_ENV}.tls.certresolver=myhttpchallenge"
      - "traefik.http.middlewares.test-compress.compress=true"
      - "traefik.frontend.redirect.regex=^https://www.${APP_URL}/(.*)"
      - "traefik.frontend.redirect.replacement=https://${APP_URL}/$${1}"
    volumes:
      - storage:/var/www/html/storage:ro,delegated
      - public_vendor:/var/www/html/public/vendor:ro,delegated
    depends_on:
      - php
    links:
      - php

volumes:
  storage:
  public_vendor:

networks:
  nginx-proxy:
    external: true
  database-network:
    external: true

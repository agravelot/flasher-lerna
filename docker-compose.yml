version: '3.4'
services:
  db:
    image: mariadb
    restart: unless-stopped
    volumes:
    - db-data:/var/lib/mysql:rw,delegated
    env_file:
    - docker/db/.env

  php:
    image: registry.gitlab.com/nevax/picblog/picblog_php:${CI_COMMIT_SHORT_SHA:-latest}
    build:
      context: .
      dockerfile: Dockerfile
      target: php_app
    restart: unless-stopped
    env_file:
    - docker/php-fpm/.env
    volumes:
    - storage:/var/www/html/storage:rw,delegated
    - public_vendor:/var/www/html/public/vendor:rw,delegated
    links:
    - db
    - cache
    depends_on:
    - db
    - cache

  queue:
    image: registry.gitlab.com/nevax/picblog/picblog_php:${CI_COMMIT_SHORT_SHA:-latest}
    build:
      context: .
      dockerfile: Dockerfile
      target: php_queue
    restart: unless-stopped
    env_file:
      - docker/php-fpm/.env
    environment:
      CONTAINER_ROLE: "queue"
    volumes:
      - storage:/var/www/html/storage:rw,delegated
      - public_vendor:/var/www/html/public/vendor:rw,delegated
    links:
      - db
      - cache
    depends_on:
      - db
      - cache

  scheduler:
    image: registry.gitlab.com/nevax/picblog/picblog_php:${CI_COMMIT_SHORT_SHA:-latest}
    build:
      context: .
      dockerfile: Dockerfile
      target: php_scheduler
    restart: unless-stopped
    env_file:
      - docker/php-fpm/.env
    environment:
      CONTAINER_ROLE: "scheduler"
    volumes:
      - storage:/var/www/html/storage:rw,delegated
      - public_vendor:/var/www/html/public/vendor:rw,delegated
    links:
      - db
      - cache
    depends_on:
      - db
      - cache

  publisher:
    image: registry.gitlab.com/nevax/picblog/picblog_php:${CI_COMMIT_SHORT_SHA:-latest}
    build:
      context: .
      dockerfile: Dockerfile
      target: php_publisher
    restart: on-failure
    env_file:
      - docker/php-fpm/.env
    environment:
      CONTAINER_ROLE: "publisher"
    volumes:
      - storage:/var/www/html/storage:rw,delegated
      - public_vendor:/var/www/html/public/vendor:rw,delegated
    links:
      - db
      - cache
    depends_on:
      - db
      - cache

  nginx:
    image: registry.gitlab.com/nevax/picblog/picblog_nginx:${CI_COMMIT_SHORT_SHA:-latest}
    build:
      context: .
      dockerfile: Dockerfile
      target: nginx
    restart: unless-stopped
    ports:
    - 8080:80
    env_file: ./docker/nginx/.env
    volumes:
    - storage:/var/www/html/storage:ro,delegated
    - public_vendor:/var/www/html/public/vendor:ro,delegated
    depends_on:
    - php
    links:
    - php

  cache:
    image: redis:5.0-alpine
    restart: unless-stopped
    volumes:
      - cache_data:/data:rw,delegated

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    restart: unless-stopped
    links:
    - db
    depends_on:
    - db
    ports:
    - 8082:80
    environment:
    - PHP_UPLOAD_MAX_FILESIZE=100MB

volumes:
  db-data:
  storage:
  public_vendor:
  cache_data:

networks:
  default:
    external:
      name: nginx-proxy

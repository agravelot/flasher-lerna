# https://about.gitlab.com/2016/05/23/gitlab-container-registry/

image: docker

services:
- docker:dind

stages:
- build
- test
- review
- deploy

variables:
  CONTAINER_TEST_IMAGE: registry.gitlab.com/nevax/picblog:$CI_BUILD_REF_NAME
  CONTAINER_RELEASE_IMAGE: registry.gitlab.com/nevax/picblog:latest
  CONTAINER_IMAGE: registry.gitlab.com/$CI_PROJECT_PATH
  DOCKER_HOST: tcp://docker:2375
  DOCKER_DRIVER: overlay2

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
  - .cache/pip
  - vendor/
  - node_modules

before_script:
- touch docker/db/.env docker/nginx/.env docker/php-fpm/.env
- pip install --upgrade pip
- apk add --no-cache py-pip bash gettext
- echo "Installing Docker compose" && pip install docker-compose
- echo "Docker compose version" && docker-compose version
- echo "Docker compose validating" && docker-compose config
- echo "Login to gitlab registry" && docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD registry.gitlab.com

build:
  stage: build
  script:
  - docker-compose pull
  - docker-compose build
  - docker push registry.gitlab.com/nevax/picblog/picblog_php:latest
  - docker push registry.gitlab.com/nevax/picblog/picblog_nginx:latest

unit_test:
  stage: test
  script:
  - echo "UNIT TESTS"
  - docker-compose pull
  - chmod +x docker/*.sh
  - bash -c 'cd docker/ && ./generate_env.sh staging'
  - docker-compose up -d
#  - docker-compose exec -T php apk add --no-cache autoconf dpkg-dev dpkg file g++ gcc libc-dev make pkgconf re2c
#  - docker-compose exec -T php pecl install xdebug && docker-php-ext-enable xdebug
  - docker-compose exec -T php php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
  - docker-compose exec -T php php composer-setup.php
  - docker-compose exec -T php php -r "unlink('composer-setup.php');"
  - docker-compose exec -T php php composer.phar require phpunit/phpunit
  - echo "Running unit tests"
  - docker-compose exec -T php vendor/bin/phpunit --coverage-text --colors=never --testsuite Unit
  allow_failure: true

feature_test:
  stage: test
  script:
  - echo "FEATURE TEST"
  - docker-compose pull
  - chmod +x docker/*.sh
  - bash -c 'cd docker/ && ./generate_env.sh staging'
  - docker-compose up -d
  - docker-compose exec -T php php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
  - docker-compose exec -T php php composer-setup.php
  - docker-compose exec -T php php -r "unlink('composer-setup.php');"
  - docker-compose exec -T php php composer.phar require phpunit/phpunit
  - echo "Running feature tests"
  - docker-compose exec -T php vendor/bin/phpunit --coverage-text --colors=never --testsuite Feature
  allow_failure: true

browser_test:
  stage: test
  script:
    - echo "BROWSER TEST"
    - docker-compose pull
    - chmod +x docker/*.sh
    - bash -c 'cd docker/ && ./generate_env.sh staging'
    - docker-compose up -d
    - docker-compose exec -T php php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
    - docker-compose exec -T php php composer-setup.php
    - docker-compose exec -T php php -r "unlink('composer-setup.php');"
    - docker-compose exec -T php php composer.phar require phpunit/phpunit
    - echo "Running browser tests"
    - docker-compose exec -T php vendor/bin/phpunit --coverage-text --colors=never --testsuite Browser
  allow_failure: true

lint:
  stage: review
  script:
  - echo "LINT CODE"
  - docker-compose pull
  - chmod +x docker/*.sh
  - bash -c 'cd docker/ && ./generate_env.sh staging'
  - docker-compose up -d
#  - docker-compose exec -T php apk add --no-cache autoconf dpkg-dev dpkg file g++ gcc libc-dev make pkgconf re2c
#  - docker-compose exec -T php pecl install xdebug && docker-php-ext-enable xdebug
  - docker-compose exec -T php php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
  - docker-compose exec -T php php composer-setup.php
  - docker-compose exec -T php php -r "unlink('composer-setup.php');"
  - docker-compose exec -T php php composer.phar require pheromone/phpcs-security-audit
  - docker-compose exec -T php vendor/bin/php-cs-fixer fix --dry-run --diff
  allow_failure: true

security_audit:
  stage: review
  script:
  - echo "SECURITY AUDIT"
  - docker-compose pull
  - chmod +x docker/*.sh
  - bash -c 'cd docker/ && ./generate_env.sh staging'
  - docker-compose up -d
#  - docker-compose exec -T php apk add --no-cache autoconf dpkg-dev dpkg file g++ gcc libc-dev make pkgconf re2c
#  - docker-compose exec -T php pecl install xdebug && docker-php-ext-enable xdebug
  - docker-compose exec -T php php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
  - docker-compose exec -T php php composer-setup.php
  - docker-compose exec -T php php -r "unlink('composer-setup.php');"
  - docker-compose exec -T php php composer.phar require pheromone/phpcs-security-audit
  - docker-compose exec -T php sh vendor/pheromone/phpcs-security-audit/symlink.sh
  - docker-compose exec -T vendor/bin/phpcs --standard=./vendor/pheromone/phpcs-security-audit/example_base_ruleset.xml ./vendor/pheromone/phpcs-security-audit/tests.php
  allow_failure: true

deploy_staging:
  stage: deploy
  script:
  - echo "Deploying staging"
  - apk add --no-cache openssh-client socat bash
  - eval $(ssh-agent -s)
  - mkdir -p ~/.ssh
  - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
  - chmod +x docker/*.sh
  - bash -c 'cd docker/ && ./generate_env.sh staging'
  - bash -c 'cd docker/ && ./deploy.sh staging'
  environment:
    name: staging
    url: https://nevax.awsmppl.com
  except:
    - master

deploy_production:
  stage: deploy
  script:
  - echo "Deploying production"
  - apk add --no-cache openssh-client socat bash
  - eval $(ssh-agent -s)
  - mkdir -p ~/.ssh
  - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
  - chmod +x docker/*.sh
  - bash -c 'cd docker/ && ./generate_env.sh production'
  - bash -c 'cd docker/ && ./deploy.sh production'
  environment:
    name: production
    url: https://agravelot.com
  when: manual
  only:
  - master

version: '3.7'
services:

  traefik:
    image: "traefik:v2.2"
    restart: unless-stopped
    command:
      - "--log.level=DEBUG"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--providers.docker.network=nginx-proxy"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.foo.http.redirections.entryPoint.scheme=https"
      - "--entrypoints.foo.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.foo.http.redirections.entrypoint.permanent=false"
      - "--certificatesresolvers.myhttpchallenge.acme.httpchallenge=true"
      - "--certificatesresolvers.myhttpchallenge.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.myhttpchallenge.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.myhttpchallenge.acme.email=antoine.gravelot@hotmail.fr"
      - "--certificatesresolvers.myhttpchallenge.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    networks:
      - nginx-proxy

  tusd:
    labels:
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-tusd.tls=true"
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME}-tusd-headers.headers.isDevelopment=true"
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME}-tusd-headers.headers.accessControlMaxAge=1"

  nginx:
    environment:
      NGINX_HOST: ${APP_URI}
      ERROR_LOG_LEVEL: ${ERROR_LOG_LEVEL}
#    ports:
#    - "8090:80"
    labels:
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}.tls=true"
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME}-headers.headers.isDevelopment=true"
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME}-headers.headers.accessControlMaxAge=1"
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME}-error-check.circuitbreaker.expression=NetworkErrorRatio() > 0.10"

  php:
    environment:
      APP_DEBUG: "true"
      DB_PASSWORD: ${DB_PASSWORD}
      SESSION_SECURE_COOKIE: null
      TELESCOPE_ENABLED: "true"

  cache:
    image: redis:5.0-alpine
    restart: unless-stopped
    networks:
      - database-network
    volumes:
      - cache_data:/data:rw,delegated

  db:
    image: postgres:11-alpine
    restart: unless-stopped
    expose:
      - "5432"
    networks:
      - database-network
    volumes:
      - db-data:/var/lib/postgresql/data:rw,delegated
    environment:
      POSTGRES_DB: flasher
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: ${DB_PASSWORD}

volumes:
  cache_data:
  db-data:

networks:
  nginx-proxy:
    external: true
  database-network:
    external: true
